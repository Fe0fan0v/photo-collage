# Контекст работы: Фото-коллаж на тарелке

## Описание проекта
Веб-приложение для выставки: два участника делают фото, система удаляет фон, соединяет половинки лиц на декоративной тарелке.

## Серверы

| Сервис | URL |
|--------|-----|
| Сайт | https://collage.heliad.ru |
| API | https://collage.heliad.ru/api |
| SSH | admin@158.160.141.83 |

**IP сервера**: 158.160.141.83
**Репозиторий**: https://github.com/Fe0fan0v/photo-collage.git

## Структура проекта

```
photo-collage/
├── index.html
├── package.json
├── vite.config.js
├── src/
│   ├── main.js               # Точка входа
│   ├── styles/
│   │   └── main.css
│   ├── screens/
│   │   ├── camera.js         # Камера + захват фото (стартовый экран)
│   │   ├── photos-ready.js   # Подтверждение готовности фото + переснять
│   │   ├── plate-select.js   # Выбор тарелки (6 вариантов)
│   │   ├── processing.js     # Обработка + анимированный прелоадер
│   │   ├── email-form.js     # Ввод email + тип клиента
│   │   └── success.js        # Результат + действия
│   ├── services/
│   │   ├── background-removal.js  # Вызов API бэкенда
│   │   └── collage.js        # Сборка коллажа на Canvas
│   ├── utils/
│   │   └── helpers.js
│   └── assets/
│       ├── background-pattern.png  # Фоновый паттерн "ёлочка"
│       ├── logo.png                # Логотип SELETTI × DELIGHT
│       ├── plate-1.png             # Сине-зеленая с драконом
│       ├── plate-2.png             # Бело-синяя с цветами
│       ├── plate-3.png             # Красно-желто-синяя с хохломой
│       ├── plate-4.png             # Зелено-красная
│       ├── plate-5.png             # Черно-синяя с цветами
│       └── plate-6.png             # Оранжево-черная
└── backend/
    ├── main.py               # FastAPI сервер
    ├── requirements.txt
    └── venv/                 # Python виртуальное окружение
```

## Технологии

### Frontend
- Vite 5.4
- Vanilla JavaScript (ES6 modules)
- HTML5 Canvas для коллажа
- getUserMedia API для камеры

### Backend
- Python 3.12
- FastAPI + Uvicorn
- rembg (модель u2net) - удаление фона
- MediaPipe FaceLandmarker - детекция лица и глаз
- OpenCV (haarcascade) - fallback детекция

### Инфраструктура
- Nginx - reverse proxy + SSL termination
- Let's Encrypt - SSL сертификат (автообновление)
- Systemd - автозапуск сервисов

## API Endpoints

Base URL: `https://collage.heliad.ru/api`

### GET /api/health
Проверка состояния сервера
```json
{"status": "ok", "model_loaded": true}
```

### POST /api/process-face
Удаление фона + детекция лица
- Input: multipart/form-data с изображением
- Output:
```json
{
  "image": "data:image/png;base64,...",
  "face": {
    "x": 0.25,      // позиция в % от ширины
    "y": 0.15,      // позиция в % от высоты
    "width": 0.5,   // ширина лица в %
    "height": 0.4,  // высота лица в %
    "found": true
  },
  "width": 1280,
  "height": 720
}
```

## Логика коллажа (collage.js)

### Размеры
- OUTPUT_SIZE: 1100px (итоговое изображение)
- PLATE_SIZE: 1035px (тарелка с орнаментом)
- FACE_WIDTH: 580px, FACE_HEIGHT: 720px (овал для лица внутри орнамента)

### Процесс
1. Обработать оба фото через `/api/process-face`
2. Нарисовать зигзаг-паттерн фона
3. Нарисовать тарелку (круглое изображение)
4. Нарисовать лица в овале:
   - Масштабирование по межзрачковому расстоянию (28% ширины овала)
   - Выравнивание по позиции глаз (40% от верха овала)
   - Левая половина от фото 1, правая от фото 2
5. Нарисовать разделительную линию

## Команды для управления

```bash
# SSH на сервер
ssh admin@158.160.141.83

# Статус сервисов
sudo systemctl status collage-frontend
sudo systemctl status collage-backend

# Перезапуск сервисов
sudo systemctl restart collage-frontend
sudo systemctl restart collage-backend

# Логи сервисов
sudo journalctl -u collage-frontend -f
sudo journalctl -u collage-backend -f

# Nginx
sudo systemctl status nginx
sudo nginx -t  # проверка конфига
sudo systemctl reload nginx

# SSL сертификат (автообновляется certbot)
sudo certbot certificates
```

### Systemd сервисы

| Сервис | Файл | Описание |
|--------|------|----------|
| collage-frontend | /etc/systemd/system/collage-frontend.service | Vite dev server на порту 3007 |
| collage-backend | /etc/systemd/system/collage-backend.service | FastAPI на порту 3008 |

### Nginx конфигурация

Файл: `/etc/nginx/sites-enabled/collage.heliad.ru`

- `/` -> proxy_pass http://127.0.0.1:3007 (frontend)
- `/api/` -> proxy_pass http://127.0.0.1:3008/ (backend)

## Что сделано

### Основной функционал
- [x] Frontend с экранами (welcome, camera, plate-selection, processing, success)
- [x] HTTPS через Let's Encrypt (домен collage.heliad.ru)
- [x] Python backend с rembg для удаления фона
- [x] Детекция лица и глаз через MediaPipe FaceLandmarker
- [x] Овальная маска для лиц (580x720px)
- [x] Выравнивание половинок по позиции глаз
- [x] Масштабирование по межзрачковому расстоянию

### UX улучшения
- [x] Превью первого фото при съемке второго
  - Обработка фото 1 сразу после захвата
  - Показ правильно позиционированного лица в левой половине овала
  - Второй человек видит точное положение для выравнивания
- [x] Адаптивный дизайн для desktop и mobile
  - Media queries для экранов 768px+
  - Оптимизация размеров камеры и элементов управления
  - Корректное центрирование видео (object-position: center)
- [x] Улучшенная обработка ошибок
  - Детальные сообщения об ошибках API
  - Проверка доступности backend на welcome screen
  - Таймауты и fallback для сетевых запросов
  - Индикатор обработки фото

## Что нужно доработать

- [ ] Email отправка через EmailJS
- [ ] Сохранение email в Google Sheets
- [ ] Возможно: ручная корректировка позиции лица пользователем (если понадобится)

## Известные проблемы

1. **Детекция лица** - MediaPipe надёжнее haarcascade, но может не найти лицо при плохом освещении (есть fallback)
2. **Обработка времени** - удаление фона через rembg занимает 10-30 секунд на фото
3. **Первый запуск backend** - скачивание модели MediaPipe (~5MB) при первом запуске

## Последние изменения (2026-02-05)

### Полное обновление UI/UX

#### Новые экраны и функции
- **Photos Ready Screen** - промежуточный экран после съемки обоих фото
  - Превью обоих фотографий
  - Индивидуальные кнопки "ПЕРЕСНЯТЬ" под каждым фото
  - Возможность пересъемки конкретного фото без потери другого
  - Кнопка "ДАЛЕЕ" для продолжения к выбору тарелки

#### Анимации и визуальная обратная связь
- **Анимация после первого фото:**
  - Желтая галочка появляется с плавной анимацией (scale + fade)
  - Пульсирующий контур овала-гида (желтое свечение)
  - Текст "⏳ Обработка..." во время обработки
  - Устраняет ощущение зависания (1-2 секунды обработки)

#### Обновленный экран выбора тарелки
- **6 тарелок** вместо 3 (новые дизайны добавлены)
- **Вертикальная раскладка** с прокруткой
- **Желтые круги с номерами** (1-6) чередуются слева/справа от тарелок
- Заголовок "Выберите фон"
- Кнопка "СОЗДАТЬ HYBRID"
- Анимация при выборе (масштабирование + желтая обводка)

#### Экран обработки (Processing)
- Заголовок "Создаем Hybrid"
- Анимированный прелоадер (крутящийся spinner)
- Динамический текст с этапами:
  - "Подготовка..."
  - "Обрабатываем фото 1..."
  - "Обрабатываем фото 2..."
  - "Загружаем фон..."
  - "Создаем гибрид..."
  - "Финальные штрихи..."
- Убран прогресс-бар (заменен на текст + spinner)
- Темный полупрозрачный фон для читаемости

#### Обновленный Success экран
- Показ готового коллажа
- Три основные кнопки:
  - "ОТПРАВИТЬ НА ПОЧТУ В ХОРОШЕМ КАЧЕСТВЕ"
  - "РАСПЕЧАТАТЬ У МЕНЕДЖЕРА СТЕНДА"
  - "НАЧАТЬ СНАЧАЛА" (компактная)
- Подтверждение "Готово!" после отправки email (автозакрытие через 2.5 сек)
- Темный фон для всего экрана

#### Email Form экран
- Поле "Email*" (обязательное)
- Выпадающий список "Вы" (необязательный):
  - Частный покупатель (по умолчанию)
  - Дизайнер
  - Дилер
  - Поставщик
- Кнопка "ОТПРАВИТЬ"
- Желтая кнопка закрытия (×) в правом верхнем углу
- Неактивные (затемненные) кнопки на фоне
- Возврат к Success экрану при закрытии

#### Единый стиль всех экранов
- Темный полупрозрачный фон `rgba(0, 0, 0, 0.85)` на ВСЕХ экранах:
  - Success
  - Photos Ready
  - Email Form
  - Plate Selection
  - Processing
- Закругленные углы контейнеров
- Отступы от краев (margin: 20px)
- Улучшенная читаемость текста на фоне паттерна "ёлочка"

#### Обновленный флоу приложения
```
Camera (фото 1)
  → Camera (фото 2)
  → Photos Ready (подтверждение + переснять)
  → Plate Selection (выбор из 6 тарелок)
  → Processing (анимация обработки)
  → Success (результат + действия)
  → Email Form (отправка на почту) [опционально]
  → Success (с "Готово!" 2.5 сек)
```

#### Технические улучшения
- Поддержка параметра `customerType` в EmailJS и Google Sheets
- Метод `retakePhoto(index)` для пересъемки конкретного фото
- Восстановление состояния камеры при возврате для пересъемки
- Передача параметров между экранами через `mount(params)`
- Кнопка закрытия с навигацией назад

---

## Изменения (2026-02-03)

### Редизайн UI в стиле SELETTI × DELIGHT
- **Брендинг**: логотип "SELETTI × DELIGHT" на белом полупрозрачном фоне
- **Фон**: паттерн "ёлочка" (chevron) из файла `background-pattern.png` (200px)
- **Цветовая схема**:
  - Акцент: жёлтый `#FFED00`
  - Фон: чёрный `#000000`
  - Текст: белый на тёмном, чёрный на жёлтом
- **Шрифт**: PT Sans Caption (Google Fonts)

### Экран камеры (стартовый)
- Welcome экран удалён — приложение сразу открывает камеру
- Камера с отступами по бокам (16px), закруглённые нижние углы
- Пунктирный белый овал для позиционирования лица
- Жёлтая вертикальная линия по центру
- Жёлтый индикатор стороны ("Левая половина" / "Правая половина")
- Инструкция на чёрном фоне для читаемости
- Компактная кнопка съёмки (56px): жёлтый круг + чёрная обводка 4px + жёлтое внешнее кольцо
- Миниатюры Фото1/Фото2: белая сплошная рамка (70x62px)
- Превью первого лица в овале (33% ширины, 77% высоты)

### Экран обработки
- Чёрная полупрозрачная подложка для читаемости текста

### Навигация
- "Сделать ещё фото" ведёт сразу на камеру (не на welcome)

### Файлы
- `src/assets/background-pattern.png` — фоновый паттерн
- `src/assets/logo.png` — логотип SELETTI × DELIGHT
- `src/screens/welcome.js` — удалён

---

## Изменения (2026-01-29)

### Настройка размеров лица и тарелки под референс
- **OUTPUT_SIZE**: остался 1100px (больше фона вокруг тарелки)
- **PLATE_SIZE**: 1035px → 900px (тарелка меньше относительно фона, ~82% вместо 94%)
- **FACE_WIDTH/HEIGHT**: 580x720 → 900x900px (полный размер тарелки для обрезки по PNG маске)
- **targetEyeDistance**: 28% → 24% (размер лица меньше, соответствует референсу)
- **targetEyeY**: 40% → 46% (глаза ниже, подбородок доходит до края тарелки)
- Лицо теперь рисуется на всю область тарелки и обрезается точно по PNG alpha-маске
- Нижний край лица (подбородок) обрезается по круглой форме тарелки, а не выше

### Переход на PNG тарелки с прозрачностью
- Тарелки теперь используют PNG формат с alpha-каналом
- Лица обрезаются через `globalCompositeOperation = 'destination-in'` с PNG маской
- Убраны функции removeWhiteBackground и createPlateMask (больше не нужны)
- Точная обрезка по форме тарелки без артефактов

### Исправление Vite конфигурации и доступности API
- Добавлен `allowedHosts: ['collage.heliad.ru', 'localhost']` в vite.config.js
- Убраны SSL сертификаты из Vite (./certs/ → ./certs.backup)
- Vite теперь работает в HTTP режиме, SSL обрабатывает только Nginx
- Исправлен API_URL: с `:3008` на `/api/` для работы через Nginx reverse proxy
- Backend доступен только через Nginx /api/, прямой доступ на порт 3008 закрыт

### Обновленные размеры коллажа
- OUTPUT_SIZE: 1100px
- PLATE_SIZE: 900px (~82% от canvas)
- FACE_WIDTH: 900px, FACE_HEIGHT: 900px (полный размер тарелки)
- Лицо вписывается в тарелку и обрезается по PNG alpha маске

### Обновленное позиционирование лица
- Масштабирование по межзрачковому расстоянию: 24% ширины овала
- Позиция глаз: 46% от верха овала (подбородок доходит до края)

---

## Изменения (2026-01-28)

### Исправление камеры на iPhone
- Добавлен `aspect-ratio: 4/3` для мобильного контейнера камеры
- Решает проблему смещения изображения ("камера смотрит слева") на iPhone 13
- Теперь пропорции контейнера фиксированы на всех устройствах

### Увеличение превью первого фото
- Размер превью увеличен для лучшего совпадения с овалом-гидом
- width: 30% → 31%, height: 70% → 72%
- left: 20% → 19% (корректировка центровки)

---

## Изменения (2026-01-26)

### MediaPipe FaceLandmarker для детекции глаз
- Заменён haarcascade на MediaPipe FaceLandmarker (tasks API v0.10+)
- Детектируются позиции глаз (iris landmarks 468, 473)
- Выравнивание половинок лиц по линии глаз (не по границам лица)
- Решает проблему с пышными прическами и бородами
- Автоматическое скачивание модели `face_landmarker.task` при запуске
- Fallback на haarcascade если MediaPipe не находит лицо

### Размеры коллажа (устарело, см. изменения от 2026-01-29)
- OUTPUT_SIZE: 1100px
- PLATE_SIZE: 900px (обновлено 2026-01-29)
- FACE_WIDTH: 900px, FACE_HEIGHT: 900px (обновлено 2026-01-29)
- Лицо рисуется на всю область тарелки и обрезается PNG alpha маской

### Позиционирование лица (устарело, см. изменения от 2026-01-29)
- Масштабирование по межзрачковому расстоянию (24% ширины овала, обновлено 2026-01-29)
- Позиция глаз: 46% от верха овала (обновлено 2026-01-29)

### Превью первого фото
- Показывает только ЛЕВУЮ половину обработанного лица
- Обрезка по области лица с padding для волос
- Отображается в левой половине овала-гида
- Полностью непрозрачное (opacity: 1)
- Растягивается на весь контейнер (background-size: 100% 100%)

### API response
- `/api/process-face` возвращает данные о глазах:
  ```json
  {
    "face": {
      "found": true,
      "x": 0.25, "y": 0.15,
      "width": 0.5, "height": 0.4,
      "eyes": {
        "left": {"x": 0.3, "y": 0.35},
        "right": {"x": 0.7, "y": 0.35},
        "center": {"x": 0.5, "y": 0.35},
        "distance": 0.4
      }
    }
  }
  ```
- `/api/health` возвращает статус MediaPipe:
  ```json
  {"status": "ok", "model_loaded": true, "mediapipe_loaded": true}
  ```

---

## Изменения (2026-01-25)

### Настройка домена и SSL
- Домен: collage.heliad.ru
- Nginx как reverse proxy (frontend + backend через один домен)
- Let's Encrypt SSL сертификат (действует до 25.04.2026)
- Systemd сервисы для автозапуска при перезагрузке
- API теперь доступен через `/api/` вместо отдельного порта :3008
- Убраны самоподписанные сертификаты (больше не нужно принимать вручную)

### Коммит c92a6c2: Превью с правильным позиционированием лица
- После захвата первого фото оно сразу обрабатывается через API
- Создаётся canvas с правильным позиционированием лица (как в финальном коллаже)
- В превью отображается только левая половина овала с лицом первого человека
- Второй человек видит точное положение для выравнивания своего лица
- Добавлен индикатор "⏳ Обработка..." во время обработки фото 1

### Коммит 9808369: Улучшения обработки ошибок, UI/UX и адаптивности
- **Обработка ошибок**: детальная диагностика ошибок API, проверка доступности backend
- **Центрирование камеры**: добавлено `object-position: center` для корректного отображения
- **Адаптивность**: media queries для desktop (768px+), оптимизация размеров элементов
- **UX**: предупреждение на welcome screen если backend недоступен

### Ранее
- Переход с клиентской библиотеки @imgly/background-removal на серверный rembg (быстрее загрузка)
- Добавлена детекция лица для точного позиционирования
- Овальная маска вместо круглой
- Выравнивание по верхнему краю лица (лоб)
