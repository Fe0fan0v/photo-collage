# Контекст работы: Фото-коллаж на тарелке

## Описание проекта
Веб-приложение для выставки: два участника делают фото, система удаляет фон, соединяет половинки лиц на декоративной тарелке.

## Серверы

| Сервис | URL | Порт |
|--------|-----|------|
| Frontend (Vite) | https://158.160.141.83:3007 | 3007 |
| Backend API (FastAPI) | https://158.160.141.83:3008 | 3008 |
| SSH | admin@158.160.141.83 | 22 |

**Репозиторий**: https://github.com/Fe0fan0v/photo-collage.git

## Структура проекта

```
photo-collage/
├── index.html
├── package.json
├── vite.config.js
├── certs/                    # SSL сертификаты
│   ├── cert.pem
│   └── key.pem
├── src/
│   ├── main.js               # Точка входа
│   ├── styles/
│   │   └── main.css
│   ├── screens/
│   │   ├── welcome.js        # Экран приветствия
│   │   ├── camera.js         # Камера + захват фото
│   │   ├── plate-selection.js # Выбор тарелки (3 варианта)
│   │   ├── processing.js     # Обработка + прогресс
│   │   └── success.js        # Результат + скачивание
│   ├── services/
│   │   ├── background-removal.js  # Вызов API бэкенда
│   │   └── collage.js        # Сборка коллажа на Canvas
│   ├── utils/
│   │   └── helpers.js
│   └── assets/
│       ├── plate-1.jpg
│       ├── plate-2.jpg
│       └── plate-3.jpg
└── backend/
    ├── main.py               # FastAPI сервер
    ├── requirements.txt
    └── venv/                 # Python виртуальное окружение
```

## Технологии

### Frontend
- Vite 5.4
- Vanilla JavaScript (ES6 modules)
- HTML5 Canvas для коллажа
- getUserMedia API для камеры

### Backend
- Python 3.12
- FastAPI + Uvicorn
- rembg (модель u2net) - удаление фона
- OpenCV (haarcascade) - детекция лица
- HTTPS с самоподписанным сертификатом

## API Endpoints

### GET /health
Проверка состояния сервера
```json
{"status": "ok", "model_loaded": true}
```

### POST /process-face
Удаление фона + детекция лица
- Input: multipart/form-data с изображением
- Output:
```json
{
  "image": "data:image/png;base64,...",
  "face": {
    "x": 0.25,      // позиция в % от ширины
    "y": 0.15,      // позиция в % от высоты
    "width": 0.5,   // ширина лица в %
    "height": 0.4,  // высота лица в %
    "found": true
  },
  "width": 1280,
  "height": 720
}
```

## Логика коллажа (collage.js)

1. Обработать оба фото через `/process-face`
2. Нарисовать зигзаг-паттерн фона
3. Нарисовать тарелку (круг 900px)
4. Нарисовать лица в овале (500x620px):
   - Оба лица масштабируются до одинаковой высоты
   - Выравнивание по верхнему краю (линия лба)
   - Левая половина от фото 1, правая от фото 2
5. Нарисовать разделительную линию

## Команды для запуска

```bash
# SSH на сервер
ssh admin@158.160.141.83

# Frontend
cd ~/photo-collage
npm run dev

# Backend
cd ~/photo-collage/backend
source venv/bin/activate
python main.py

# Проверить процессы
pgrep -f vite
pgrep -f 'python main.py'

# Логи
cat ~/vite.log
cat ~/backend.log
```

## Что сделано

### Основной функционал
- [x] Frontend с экранами (welcome, camera, plate-selection, processing, success)
- [x] HTTPS для работы камеры на мобильных
- [x] Python backend с rembg для удаления фона
- [x] Детекция лица через OpenCV (haarcascade)
- [x] Овальная маска для лиц (500x620px)
- [x] Выравнивание половинок по верхнему краю лица
- [x] Масштабирование обоих лиц до одинаковой высоты

### UX улучшения
- [x] Превью первого фото при съемке второго
  - Обработка фото 1 сразу после захвата
  - Показ правильно позиционированного лица в левой половине овала
  - Второй человек видит точное положение для выравнивания
- [x] Адаптивный дизайн для desktop и mobile
  - Media queries для экранов 768px+
  - Оптимизация размеров камеры и элементов управления
  - Корректное центрирование видео (object-position: center)
- [x] Улучшенная обработка ошибок
  - Детальные сообщения об ошибках API
  - Проверка доступности backend на welcome screen
  - Таймауты и fallback для сетевых запросов
  - Индикатор обработки фото

## Что нужно доработать

- [ ] Email отправка через EmailJS
- [ ] Сохранение email в Google Sheets
- [ ] Возможно: ручная корректировка позиции лица пользователем (если понадобится)

## Известные проблемы

1. **Детекция лица** - haarcascade может не найти лицо при плохом освещении или угле (есть fallback)
2. **Обработка времени** - удаление фона через rembg занимает 10-30 секунд на фото

## Последние изменения (2026-01-25)

### Коммит c92a6c2: Превью с правильным позиционированием лица
- После захвата первого фото оно сразу обрабатывается через API
- Создаётся canvas с правильным позиционированием лица (как в финальном коллаже)
- В превью отображается только левая половина овала с лицом первого человека
- Второй человек видит точное положение для выравнивания своего лица
- Добавлен индикатор "⏳ Обработка..." во время обработки фото 1

### Коммит 9808369: Улучшения обработки ошибок, UI/UX и адаптивности
- **Обработка ошибок**: детальная диагностика ошибок API, проверка доступности backend
- **Центрирование камеры**: добавлено `object-position: center` для корректного отображения
- **Адаптивность**: media queries для desktop (768px+), оптимизация размеров элементов
- **UX**: предупреждение на welcome screen если backend недоступен

### Ранее
- Переход с клиентской библиотеки @imgly/background-removal на серверный rembg (быстрее загрузка)
- Добавлена детекция лица для точного позиционирования
- Овальная маска вместо круглой
- Выравнивание по верхнему краю лица (лоб)
